# $Id: Makefile.in,v 1.32 1998/09/16 17:04:28 jimg Exp $

@SET_MAKE@

# Set makefile variables, some with values supplied by configure 
# DEFS gets the `-D' defines that describe what a particular system has
# or doesn't have.

# The library libdap++.a contains the code for the generation of the DAS and
# DDS structures plus the code for data transmission and the GNU libg++.a
# classes Map, Stack, Plex and Vec.
# geturl is a simple program that uses the dap++ library plus others to fetch
# a url. In addition it can read and process DAS and DDS objects, displaying
# the print representation on the screen.

LOADDODS = loaddods.mex*
PROG = writeval asciival $(LOADDODS) urlqueue

DODS_ROOT = ../..
MATLAB_ROOT = @MATLAB_ROOT@
WWW_ROOT=@WWW_ROOT@

INCS = -I. -I$(DODS_ROOT)/include -I$(MATLAB_ROOT)/extern/include @INCS@
DEFS = @DEFS@ -DUSE_LIBGXX_INLINES
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCS)
CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@ -fno-rtti
LDFLAGS = @LDFLAGS@ -L. -L$(DODS_ROOT)/lib
LFLAGS = -8
YFLAGS = -d
LIBS = -ldap++ -lrx @LIBS@
MAT_LIBS = -ldap++ @MATLIBS@ @LIBS@
TAGS_FLAGS = -b
CMEXFLAGS = -g @MAT_VERSION_FLAG@

# Set the instalation directories; prefix can be set on the command line
# during Makefile construction with `./configure --prefix /my/choice'

prefix = @prefix@
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib
includedir = $(prefix)/include
manext = 1
mandir = $(prefix)/man/man$(manext)

src = $(DODS_ROOT)/src
etcdir = $(DODS_ROOT)/etc

INSTALLMAN = man

SHELL = /bin/sh
srcdir = @srcdir@
version = @VERSION@
dir = writeval-@VERSION@

# testsuite specifics
RUNTEST = runtest
RUNTESTFLAGS = #--all --verbose

# names of key programs

LN_S = @LN_S@
CP = cp
AWK = @AWK@
CC = @CC@
CXX = @CXX@
YACC = @YACC@
LEX = @LEX@
AR = ar
TAGS = etags
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
STRIP = strip
CMEX = $(MATLAB_ROOT)/bin/cmex

CLIENTSRCS = ClientByte.cc ClientInt32.cc ClientFloat64.cc ClientStr.cc \
	ClientUrl.cc ClientArray.cc ClientStructure.cc ClientList.cc \
	ClientSequence.cc ClientFunction.cc ClientGrid.cc ClientUInt32.cc

CLIENTOBJS = ClientByte.o ClientInt32.o ClientFloat64.o ClientStr.o \
	ClientUrl.o ClientArray.o ClientStructure.o ClientList.o \
	ClientSequence.o ClientFunction.o ClientGrid.o ClientUInt32.o

ASCIISRCS = AsciiByte.cc AsciiInt32.cc AsciiFloat64.cc AsciiStr.cc \
	AsciiUrl.cc AsciiArray.cc AsciiStructure.cc AsciiList.cc \
	AsciiSequence.cc AsciiFunction.cc AsciiGrid.cc AsciiUInt32.cc

ASCIIOBJS = AsciiByte.o AsciiInt32.o AsciiFloat64.o AsciiStr.o \
	AsciiUrl.o AsciiArray.o AsciiStructure.o AsciiList.o \
	AsciiSequence.o AsciiFunction.o AsciiGrid.o AsciiUInt32.o

WV_SRCS = write_val.cc name_map.cc attributes.cc

WV_OBJS = write_val.o name_map.o attributes.o

AV_SRCS = ascii_val.cc name_map.cc

AV_OBJS = ascii_val.o name_map.o

LD_SRCS = loaddods.c variable.c queue.c extend.c

LD_OBJS = loaddods.o variable.o queue.o extend.o

URLQ_SRCS = urlqueue.c queue.c

URLQ_OBJS = urlqueue.o queue.o

all: $(PROG)

writeval: $(WV_OBJS) $(CLIENTOBJS)
	$(CXX) $(LDFLAGS) -o writeval $(WV_OBJS) $(CLIENTOBJS) $(LIBS)

asciival: $(AV_OBJS) $(ASCIIOBJS)
	$(CXX) $(LDFLAGS) -o asciival $(AV_OBJS) $(ASCIIOBJS) $(LIBS)

$(LOADDODS): $(LD_OBJS)
	$(CMEX) $(CMEXFLAGS) $(LD_OBJS)

urlqueue: $(URLQ_OBJS)
	$(CC) $(LDFLAGS) -o urlqueue $(URLQ_OBJS)

extend: 
	$(CC) -DTEST $(CFLAGS) $(CPPFLAGS) -c extend.c
	$(CMEX) $(CMEXFLAGS) -g extend.o

# Standard targets with some customization for das-test and dds-test

install: install-client

install-client: urlqueue writeval asciival $(LOADDODS)
	$(INSTALL_PROGRAM) urlqueue $(bindir)
	$(INSTALL_PROGRAM) posturl.pl $(etcdir)
	$(INSTALL_PROGRAM) -s writeval $(bindir)
	$(INSTALL_PROGRAM) -s asciival $(etcdir)
	$(INSTALL_PROGRAM) loaddods.mex* $(bindir)
	$(INSTALL_PROGRAM) loaddods.m $(bindir)
	$(INSTALL_PROGRAM) whodods.m $(bindir)
	$(INSTALL_DATA) INSTALL-matlab-client $(etcdir)

Makefile: ${srcdir}/Makefile.in
	${SHELL} ./config.status

config_writeval.h: config_writeval.h.in
	${SHELL} ./config.status

# Tests

check: writeval writeval-check 

writeval-check: writeval
	${RUNTEST} ${RUNTESTFLAGS} --tool writeval --srcdir testsuite

loaddods-check: writeval
	$(CC)  -c -g $(CFLAGS) $(CPPFLAGS) -DTEST_LOADDODS loaddods.c
	$(CC) $(LDFLAGS) -g -o test-ldods loaddods.o variable.o queue.o \
		-lefence
	-rm loaddods.o

# these tests all fail when das-test is linked with -lnew_debug.

clean:	
	-rm -f *.o *.sum *.log *~ core
	-rm -f $(PROG) loaddods.mex* extend.mex*

distclean: clean
	-rm -f config.status config.log config.cache

.PHONY: docs
docs:
	doc++ -d docs -f $(CLIENTSRCS) $(ASCIISRCS) $(WV_SRCS) $(AV_SRCS) \
		$(LD_SRCS) $(URLQ_SRCS)

.PHONY: depend
depend: 
	> dependencies
	@depend@ -m dependencies \
	-- $(CPPFLAGS) -I@GPP_INC@ -- \
	$(CLIENTSRCS) $(WV_SRCS) $(LD_SRCS) $(URLQ_SRCS)

# This is a special tar target because it builds not only the tar file for
# the core software but also the lib, etc, and bin directories. It assumes
# that the root directory for DODS is called `DODS' (no version number).
.PHONY: tar
tar:
	@echo "You should first run distclean in DODS_ROOT!"
	@echo "(ignore this if you have)"
	cd $(DODS_ROOT)/.. && \
	tar --exclude '*/old' --exclude '*/.#*' --exclude '*/CVS' \
	    --gzip --create --dereference --file DODS-$(dir).tar.gz \
	    DODS/src/$(dir)

.PHONY: update-version
update-version: check-version
	@echo "Version is: `cat version.h`"
	mv ../writeval* ../writeval-$(version)

# Compare the version encoded in this Makefile (set by configure) with the
# version in version.h. The version make variable is set up near the top of
# the Makefile.
.PHONY: check-version
check-version:
	@echo "Checking for version.h and Makefile version match-up"
	@if [ "$(version)" != "`cat version.h`" ]; \
	then \
		echo "You must manually re-run configure!"; \
		exit 1; \
	else \
		echo "Yes, they match."; \
	fi

.PHONY: tags
tags:
	$(TAGS) $(TAGS_FLAGS) *.cc *.h *.lex *.y

.SUFFIXES:      .o .cc .c

.c.o:
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

.cc.o:
	$(CXX) -c $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

include dependencies

